<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Checkout ‚Äì IndexedDB Basket</title>

    <style>
      /* =========================================================
         ‚úÖ Code Overview (Beginner Friendly)
         ---------------------------------------------------------
         ‚úÖ Purpose:
            - Checkout page that reads the basket from IndexedDB
            - Shows a summary table (Product / Qty / Price / Total)
            - Calculates total amount
            - Allows clearing the basket
            - Provides a demo "Confirm Order" action

         ‚úÖ Layout:
            - Header ‚Üí title + back button
            - Basket Summary ‚Üí table + total + actions
            - Status Bar ‚Üí dot + message (DB state)

         ‚úÖ Flow (High Level):
            1Ô∏è‚É£ Open the SAME IndexedDB database used in shop (ShopDB, version 1)
            2Ô∏è‚É£ Read all items from the "cart" store
            3Ô∏è‚É£ Render rows into the table body
            4Ô∏è‚É£ Calculate total = Œ£(price √ó qty)
            5Ô∏è‚É£ Clear basket uses cartStore.clear()
         ========================================================= */

      * {
        box-sizing: border-box; /* ‚úÖ predictable sizing */
      }

      body {
        margin: 0;
        min-height: 100vh;

        /* ‚úÖ center the checkout card */
        display: flex;
        justify-content: center;
        align-items: center;

        background: radial-gradient(circle at top, #111827, #020617 60%);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        color: #f9fafb;
      }

      /* ‚úÖ main checkout container */
      .checkout-shell {
        width: 900px;
        max-width: 95vw;
        background: #020617;
        border-radius: 20px;
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.4);
        padding: 24px 26px 28px;

        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      /* ‚úÖ top header (title + back button) */
      .checkout-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }

      .checkout-header h1 {
        margin: 0;
        font-size: 1.8rem;
      }

      .checkout-header p {
        margin: 4px 0 0;
        color: #9ca3af;
      }

      /* ‚úÖ buttons (shared) */
      button {
        padding: 8px 14px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        color: #e5e7eb;
        background: #2563eb;
        transition: 0.18s;
        box-shadow: 0 3px 10px rgba(37, 99, 235, 0.45);
      }

      button:hover {
        background: #1d4ed8;
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: #6b7280;
      }

      .btn-secondary:hover {
        background: #4b5563;
      }

      .btn-danger {
        background: #dc2626;
      }

      .btn-danger:hover {
        background: #b91c1c;
      }

      /* ‚úÖ box that holds the table + totals */
      .table-box {
        background: #030712;
        border-radius: 16px;
        padding: 14px 16px;
        border: 1px solid rgba(55, 65, 81, 0.9);
      }

      .section-title {
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 8px;
      }

      /* ‚úÖ table styling */
      table {
        width: 100%;
        border-collapse: collapse;
        background: #020617;
        border-radius: 10px;
        overflow: hidden;
      }

      th,
      td {
        padding: 7px 9px;
        border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      }

      th {
        background: #0f172a;
        font-weight: 600;
      }

      tbody tr:nth-child(even) {
        background: #020617;
      }
      tbody tr:nth-child(odd) {
        background: #030712;
      }

      .empty {
        font-size: 0.85rem;
        color: #9ca3af;
        margin-top: 6px;
      }

      /* ‚úÖ total row */
      .summary-row {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        font-size: 1rem;
      }

      .total-value {
        font-weight: 700;
        color: #4ade80;
      }

      /* ‚úÖ status bar (bottom) */
      .status-bar {
        font-size: 0.8rem;
        color: #9ca3af;
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 6px;
      }

      .dot-ok {
        background: #22c55e; /* ‚úÖ green */
      }
      .dot-wait {
        background: #facc15; /* ‚úÖ yellow */
      }

      .status-row {
        display: flex;
        align-items: center;
      }
    </style>
  </head>

  <body>
    <div class="checkout-shell">
      <!-- ======================================================
           ‚úÖ HEADER
           ====================================================== -->
      <div class="checkout-header">
        <div>
          <h1>Checkout</h1>
          <p>Review your basket items stored in IndexedDB</p>
        </div>

        <!-- ‚úÖ Back to shop page -->
        <button class="btn-secondary" onclick="goBack()">‚¨Ö Back to Shop</button>
      </div>

      <!-- ======================================================
           ‚úÖ BASKET TABLE
           ====================================================== -->
      <div class="table-box">
        <div class="section-title">üß∫ Basket Summary</div>

        <table>
          <thead>
            <tr>
              <th>Product</th>
              <th style="width: 80px">Qty</th>
              <th style="width: 90px">Price</th>
              <th style="width: 100px">Total</th>
            </tr>
          </thead>

          <!-- ‚úÖ JS will insert rows here -->
          <tbody id="basketBody"></tbody>
        </table>

        <!-- ‚úÖ Small helper message under the table -->
        <div id="emptyMsg" class="empty">Loading basket...</div>

        <!-- ‚úÖ Total amount summary -->
        <div class="summary-row">
          <span>Total Amount:</span>
          <span id="totalAmount" class="total-value">$0.00</span>
        </div>

        <!-- ‚úÖ Actions -->
        <div style="margin-top: 12px; display: flex; gap: 8px">
          <button class="btn-danger" onclick="clearBasket()">
            üóë Clear Basket
          </button>
          <button onclick="confirmOrder()">‚úÖ Confirm Order</button>
        </div>
      </div>

      <!-- ======================================================
           ‚úÖ STATUS BAR
           ====================================================== -->
      <div class="status-bar">
        <div class="status-row">
          <span id="statusDot" class="status-dot dot-wait"></span>
          <span id="statusText">Opening database...</span>
        </div>
        <span>Basket stored in IndexedDB ‚Üí cart</span>
      </div>
    </div>

    <script>
      /* =========================================================
         ‚úÖ Code Overview (JavaScript Part)
         ---------------------------------------------------------
         ‚úÖ Goal:
            - Open existing IndexedDB database (ShopDB)
            - Read all items from "cart" store
            - Render basket rows in a table
            - Compute total amount
            - Provide clear + confirm + back navigation

         ‚úÖ Important Rule:
            - DB name + version must match the shop page:
              "ShopDB" and version 1 ‚úÖ
         ========================================================= */

      /* =========================================================
         ‚úÖ 1) GLOBALS + DOM CACHING
         ========================================================= */

      // ‚úÖ IndexedDB database reference (set after opening)
      let db = null;

      // ‚úÖ Cache DOM references once
      const basketBody = document.getElementById("basketBody");
      const emptyMsg = document.getElementById("emptyMsg");
      const totalAmount = document.getElementById("totalAmount");
      const statusDot = document.getElementById("statusDot");
      const statusText = document.getElementById("statusText");

      /* =========================================================
         ‚úÖ 2) STATUS HELPERS (dot + message)
         ========================================================= */

      // ‚úÖ Show OK status (green dot)
      function setStatusOk(msg) {
        statusDot.classList.remove("dot-wait");
        statusDot.classList.add("dot-ok");
        statusText.textContent = msg;
      }

      // ‚úÖ Show waiting/busy status (yellow dot)
      function setStatusWait(msg) {
        statusDot.classList.remove("dot-ok");
        statusDot.classList.add("dot-wait");
        statusText.textContent = msg;
      }

      /* =========================================================
         ‚úÖ 3) OPEN EXISTING DATABASE (ShopDB)
         ---------------------------------------------------------
         - Must match the shop page:
           Name: "ShopDB"
           Version: 1
         ========================================================= */

      setStatusWait("Opening database...");

      // ‚úÖ Open database (same as shop)
      const request = indexedDB.open("ShopDB", 1);

      // ‚úÖ When DB opens successfully
      request.onsuccess = function (e) {
        db = e.target.result; // save db reference
        setStatusOk("Database opened.");
        loadCart(); // now we can read cart items
      };

      // ‚úÖ When open fails
      request.onerror = function () {
        setStatusWait("Error opening DB.");
        console.error("DB error");
      };

      /* =========================================================
         ‚úÖ 4) LOAD BASKET FROM "cart" STORE
         ---------------------------------------------------------
         - Read all cart items
         - Build table rows
         - Calculate total
         ========================================================= */

      function loadCart() {
        // ‚úÖ Clear old UI before re-render
        basketBody.innerHTML = "";
        emptyMsg.textContent = "Loading basket...";

        // ‚úÖ readonly transaction to read cart
        const tx = db.transaction("cart", "readonly");
        const store = tx.objectStore("cart");

        // ‚úÖ getAll returns all cart items
        const req = store.getAll();

        req.onsuccess = function () {
          const items = req.result;

          // ‚úÖ If basket is empty
          if (!items || items.length === 0) {
            emptyMsg.textContent = "Basket is empty.";
            totalAmount.textContent = "$0.00";
            return;
          }

          // ‚úÖ Hide empty message
          emptyMsg.textContent = "";

          let total = 0;

          // ‚úÖ Build one table row per item
          items.forEach((item) => {
            const tr = document.createElement("tr");

            // ‚úÖ row columns:
            // product name | qty | unit price | item total
            tr.innerHTML = `
              <td>${item.name}</td>
              <td>${item.quantity}</td>
              <td>$${item.price.toFixed(2)}</td>
              <td>$${(item.price * item.quantity).toFixed(2)}</td>
            `;

            // ‚úÖ accumulate total
            total += item.price * item.quantity;

            // ‚úÖ append row to table body
            basketBody.appendChild(tr);
          });

          // ‚úÖ update total amount UI
          totalAmount.textContent = "$" + total.toFixed(2);
        };
      }

      /* =========================================================
         ‚úÖ 5) CLEAR BASKET (cartStore.clear)
         ========================================================= */

      function clearBasket() {
        if (!confirm("Clear entire basket?")) return;

        // ‚úÖ readwrite transaction because we will delete data
        const tx = db.transaction("cart", "readwrite");
        const store = tx.objectStore("cart");

        // ‚úÖ clear all rows in the cart store
        store.clear().onsuccess = () => {
          emptyMsg.textContent = "Basket is empty.";
          basketBody.innerHTML = "";
          totalAmount.textContent = "$0.00";
          setStatusOk("Basket cleared.");
        };
      }

      /* =========================================================
         ‚úÖ 6) CONFIRM ORDER (DEMO ONLY)
         ========================================================= */

      function confirmOrder() {
        // ‚úÖ In real systems:
        // - you would send items to a backend (API)
        // - store order in DB
        // - handle payment flow
        alert("Demo only: Order confirmed!");
      }

      /* =========================================================
         ‚úÖ 7) NAVIGATION
         ========================================================= */

      function goBack() {
        // ‚úÖ Return to shop page
        window.location.href = "shop.html";
      }
    </script>
  </body>
</html>
